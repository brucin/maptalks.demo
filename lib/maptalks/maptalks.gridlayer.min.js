/*!
 * maptalks.gridlayer v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),i=0;i<r.length;i++){var o=r[i],n=Object.getOwnPropertyDescriptor(e,o);n&&n.configurable&&void 0===t[o]&&Object.defineProperty(t,o,n)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var a={lineColor:"#bbb",lineWidth:1,lineOpacity:1,lineDasharray:[],lineCap:"butt",lineJoin:"round",polygonOpacity:0},s={symbol:e.Util.extend({},a),debug:!1},l=function(t){function r(e,n,a){i(this,r);var s=o(this,t.call(this,e,a));return s._grid=n,s}return n(r,t),r.prototype.getGrid=function(){return this._grid},r.prototype.setGrid=function(t){return this._grid=t,this.redraw()},r.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer().redraw(),this},r.prototype.isEmpty=function(){return!this._grid},r.prototype.clear=function(){return delete this._grid,this.fire("clear"),this.redraw()},r.prototype.identify=function(t){var r=this.getMap(),i=this.getGrid(),o=i.cols||["*","*"],n=i.rows||["*","*"];if(!i.projection)return null;var a=r._getResolution(),s=i.width/a,l=i.height/a,c=r.coordinateToContainerPoint(new e.Coordinate(i.center)),d=r.coordinateToContainerPoint(t),p=new e.Extent("*"===o[0]?-Number.MAX_VALUE:c.x+o[0]*s,"*"===n[0]?-Number.MAX_VALUE:c.y+n[0]*l,"*"===o[1]?Number.MAX_VALUE:c.x+o[1]*s,"*"===n[1]?Number.MAX_VALUE:c.y+n[1]*l);if(!p.contains(d))return null;var h=1e-6,y=Math.ceil(Math.abs(d.x-c.x)/s-h),u=Math.ceil(Math.abs(d.y-c.y)/l-h);y=d.x>c.x?y-1:-y,u=d.y>c.y?u-1:-u;var g=c.add(s*y,l*u),f=r.containerPointToCoordinate(g),m=r.containerPointToCoordinate(g.add(s,0)),_=r.containerPointToCoordinate(g.add(0,l)),v=r.computeLength(f,m),b=r.computeLength(f,_);return new e.Rectangle(f,v,b)},r.prototype.toJSON=function(){var t=this.getGrid();return t.center instanceof e.Coordinate&&(t.center=t.center.toArray()),{type:"GridLayer",id:this.getId(),options:this.config(),grid:t}},r.fromJSON=function(t){return t&&"GridLayer"===t.type?new r(t.id,t.grid,t.options):null},r}(e.Layer);l.mergeOptions(s),l.registerJSONType("GridLayer");var c=[e.symbolizer.ImageMarkerSymbolizer,e.symbolizer.TextMarkerSymbolizer,e.symbolizer.VectorMarkerSymbolizer,e.symbolizer.VectorPathMarkerSymbolizer];l.registerRenderer("canvas",function(t){function r(){return i(this,r),o(this,t.apply(this,arguments))}return n(r,t),r.prototype.draw=function(){var t=this.layer.getGrid();return t?(this.prepareCanvas(),this._setCanvasStyle(this._compiledGridStyle),this._drawGrid(),this._drawData(),void this.completeRender()):void this.completeRender()},r.prototype.checkResources=function(){if(this._compileStyles(),this._resources)return null;var t=[];return this._compiledGridStyle&&(t=e.Util.getExternalResources(this._compiledGridStyle)),this._compiledSymbols&&this._compiledSymbols.forEach(function(r){var i=e.Util.getExternalResources(r);i&&(t=t.concat(i))}),t},r.prototype.redraw=function(){},r.prototype._compileStyles=function(){var t=this;if(!this._compiledGridStyle){var r=e.Util.convertResourceUrl(this.layer.options.symbol);this._compiledGridStyle=e.MapboxUtil.loadFunctionTypes(r,function(){return[t.getMap()?t.getMap().getZoom():null,null]})}this._compiledSymbols||!function(){var r=t.getMap(),i=t.layer.getGrid(),o=i.data;t._compiledSymbols=[],o&&o.forEach(function(i,o){if(i[2].symbol){var n=function(t){return function(){return[r.getZoom(),t]}}(i[2].properties),a=e.Util.convertResourceUrl(i[2].symbol);t._compiledSymbols[o]=e.MapboxUtil.loadFunctionTypes(a,n)}})}()},r.prototype._drawGrid=function(){var t=this.layer.getGrid(),r=t.projection?this._getProjGridToDraw():this._getGridToDraw();if(r){var i=r.cols,o=r.rows,n=r.width,a=r.height,s=this._getCellNW(i[0],o[0],r),l=void 0,c=void 0;if(this.context.beginPath(),!((n<.5||a<.5||this._compiledGridStyle.polygonOpacity>0||this._compiledGridStyle.polygonColor||this._compiledGridStyle.polygonPatternFile)&&(c=this._getCellNW(i[1]+1,o[1]+1,r),this.context.rect(s[0],s[1],c[0]-s[0],c[1]-s[1]),this._compiledGridStyle.polygonOpacity>0?e.Canvas.fillCanvas(this.context,this._compiledGridStyle.polygonOpacity,s[0],s[1]):e.Canvas.fillCanvas(this.context,1,s[0],s[1]),n<.5||a<.5))){for(var d=i[0];d<=i[1]+1;d++)l=this._getCellNW(d,o[0],r),c=this._getCellNW(d,o[1]+1,r),this.context.moveTo(l[0],l[1]),this.context.lineTo(c[0],c[1]);for(var p=o[0];p<=o[1]+1;p++)l=this._getCellNW(i[0],p,r),c=this._getCellNW(i[1]+1,p,r),this.context.moveTo(l[0],l[1]),this.context.lineTo(c[0],c[1]);e.Canvas._stroke(this.context,this._compiledGridStyle.lineOpacity,s[0],s[1])}}},r.prototype._getProjGridToDraw=function(){var t=this.layer.getGrid(),r=this.getMap(),i=r.getSize(),o=r._getResolution(),n=t.cols||["*","*"],a=t.rows||["*","*"],s=r.coordinateToContainerPoint(new e.Coordinate(t.center)),l=t.width/o,c=t.height/o,d=1e-6,p=-s.x+i.width,h=-s.y+i.height,y=new e.PointExtent(-s.x>0?Math.ceil(-s.x/l-d)-1:-Math.ceil(s.x/l-d),-s.y>0?Math.ceil(-s.y/c-d)-1:-Math.ceil(s.y/c-d),p>0?Math.ceil(p/l-d):-Math.ceil(p/l-d),h>0?Math.ceil(h/c-d):-Math.ceil(h/c-d)),u=new e.PointExtent("*"===n[0]?y.xmin:n[0],"*"===a[0]?y.ymin:a[0],"*"===n[1]?y.xmax:n[1],"*"===a[1]?y.ymax:a[1]),g=y.intersection(u);return g?{cols:[g.xmin,g.xmax],rows:[g.ymin,g.ymax],width:l,height:c,center:s}:null},r.prototype._getCellNW=function(t,e,r){var i=this.layer.getGrid();return i.projection?[r.center.x+(t>0?t-1:t)*r.width,r.center.y+(e>0?e-1:e)*r.height]:null},r.prototype._getCellCenter=function(t,e,r){var i=this.layer.getGrid();return i.projection?[r.center.x+((t>0?t-1:t)+.5)*r.width,r.center.y+((e>0?e-1:e)+.5)*r.height]:null},r.prototype._drawData=function(){var t=this,r=this.layer.getGrid(),i=r.projection?this._getProjGridToDraw():this._getGridToDraw(),o=r.data;Array.isArray(o)&&o.length&&(this._gridSymbolTests||(this._gridSymbolTests=[]),o.forEach(function(r,o){r[2].symbol&&(t._drawDataGrid(r,t._compiledSymbols[o],i),e.Util.isNil(t._gridSymbolTests[o])&&(t._gridSymbolTests[o]=t._testSymbol(r[2].symbol)),t._gridSymbolTests[o]&&t._drawDataCenter(r,o,i))}))},r.prototype._drawDataGrid=function(t,r,i){for(var o=this.getMap(),n=o.getSize(),a=new e.PointExtent(0,0,n.width,n.height),s=!1,l=Array.isArray(t[0])?t[0]:[t[0],t[0]],c=Array.isArray(t[1])?t[1]:[t[1],t[1]],d=this._getCellNW(l[0],c[0],i),p=void 0,h=void 0,y=void 0,u=l[0];u<=l[1];u++)for(var g=c[0];g<=c[1];g++)p=this._getCellNW(u,g,i),h=this._getCellNW(u+1,g+1,i),y=new e.PointExtent(p[0],p[1],h[0],h[1]),a.intersects(y)&&(s||(s=!0,this._setCanvasStyle(r),this.context.beginPath()),this.context.rect(Math.ceil(p[0]),Math.ceil(p[1]),Math.ceil(h[0]-p[0]),Math.ceil(h[1]-p[1])));s&&e.Canvas.fillCanvas(this.context,r.polygonOpacity,d[0],d[1])},r.prototype._testSymbol=function(t){for(var e=c.length-1;e>=0;e--)if(c[e].test(t))return!0;return!1},r.prototype._drawDataCenter=function(t,r,i){var o=t[2].symbol,n=this.getMap(),a=n.getExtent(),s=this._dataMarkers;s||(this._dataMarkers=s=[]);for(var l=[],c=Array.isArray(t[0])?t[0]:[t[0],t[0]],d=Array.isArray(t[1])?t[1]:[t[1],t[1]],p=void 0,h=void 0,y=c[0];y<=c[1];y++)for(var u=d[0];u<=d[1];u++)p=this._getCellCenter(y,u,i),h=n.containerPointToCoordinate(new e.Point(p)),a.contains(h)&&l.push(h);if(0!==l.length){var g=s[r];if(g)g.setCoordinates(l);else{var f=e.Util.extend({},o);f.markerPlacement="point",f.textPlacement="point",f.lineOpacity=0,f.polygonOpacity=0,g=new e.LineString(l,{symbol:f,properties:t[2].properties,debug:this.layer.options.debug}),g._bindLayer(this.layer),s[r]=g}g._getPainter().paint()}},r.prototype._setCanvasStyle=function(t){var r=e.Util.extend({},a,t);e.Canvas.prepareCanvas(this.context,r,this._resources)},r.prototype.onRemove=function(){delete this._compiledGridStyle,delete this._compiledSymbols,delete this._gridSymbolTests,delete this._dataMarkers},r}(e.renderer.CanvasRenderer)),t.GridLayer=l,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.gridlayer v0.1.0")});